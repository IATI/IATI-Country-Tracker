cd `dirname $0`
cd ../dstore

STARTTIME=$(date +%s)
echo "Starting Import of all xml files at $(date)" | tee -a cache/time.log


#import all xml files

doimport() {

file=$1

truncate -s 0 ${file}.import.last.log

echo | tee -a ${file}.import.log ${file}.import.last.log
date | tee -a ${file}.import.log ${file}.import.last.log
echo | tee -a ${file}.import.log ${file}.import.last.log


echo "Importing $file" | tee -a ${file}.import.log ${file}.import.last.log

node js/cmd import $file 2>&1 | tee -a ${file}.import.log ${file}.import.last.log


echo | tee -a ${file}.import.log ${file}.import.last.log
}
export -f doimport
ls cache/*.xml | sort -R | parallel --bar doimport

echo "Starting Vacuum of database at $(date)" | tee -a cache/time.log
psql -c "vacuum full verbose;" | tee cache/vacuum.log

ENDTIME=$(date +%s)
echo "Finished Import of all xml files at $(date)" | tee -a cache/time.log
echo "Import took  $(($ENDTIME - $STARTTIME)) seconds to complete." | tee -a cache/time.log
echo "" | tee -a cache/time.log

