cd `dirname $0`
cd ..


echo " creating new dload database "


source server/env.sh
export PGDATABASE="dload"


dropdb $PGDATABASE
createdb $PGDATABASE


psql -c "CREATE EXTENSION IF NOT EXISTS citext;" $PGDATABASE
psql -c "ALTER DATABASE $PGDATABASE OWNER TO $PGUSER;"
psql -c "GRANT ALL PRIVILEGES ON DATABASE $PGDATABASE TO $PGUSER;"
psql -c "GRANT CONNECT ON DATABASE $PGDATABASE TO readonly;"


bin/dstore_reset


echo " filling dload database with data "


bin/fast_import


source server/env.sh


echo " swapping dload database with dstore database "



/etc/init.d/dportal stop
/etc/init.d/dportal-instance stop

psql -c "ALTER DATABASE dstore RENAME TO dtmp;"
psql -c "ALTER DATABASE dload  RENAME TO dstore;"
psql -c "ALTER DATABASE dtmp   RENAME TO dload;"

/etc/init.d/dportal start
/etc/init.d/dportal-instance start



echo " deleting dload database "

#dropdb dload
