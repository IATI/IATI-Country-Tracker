cd `dirname $0`
cd ..

exec >/dportal/logs/cron.log


source /dportal/box/env.sh

echo
echo "Get new json data"
echo

bin/pull
bin/fetch
bin/addcommit auto json fetch in nightly cron
bin/pull
bin/push


echo
echo "Rebuilding ctrack with new json"
echo

bin/build

/etc/init.d/dportal restart
/etc/init.d/dportal status

/dportal/box/cron-download >/dportal/logs/cron.download.log 2>&1

/dportal/box/cron-swap-import 2>&1

echo
echo "Searching logs for download ERRORS"
echo
grep -i "error:" dstore/cache/*.curl.last.log
grep -i "Empty reply from server" dstore/cache/*.curl.last.log


echo
echo "Searching logs for import ERRORS"
echo
grep -i "error" dstore/cache/*.import.last.log


/dportal/box/cron-stats 2>&1


/dportal/box/cron-cronos 2>&1



echo
echo "Updating D-Portal-Logs stats"
echo

rm -rf logs/D-Portal-Logs
git clone git@github.com:xriss/D-Portal-Logs.git logs/D-Portal-Logs

cp logs/cron.log logs/D-Portal-Logs/cron.log
cp logs/cron.download.log logs/D-Portal-Logs/cron.download.log
cp logs/cron.import.log logs/D-Portal-Logs/cron.import.log

dstore/dstore stats ../logs/D-Portal-Logs/stats.json
dflat/dflat stats ../logs/D-Portal-Logs/stats.json
dflat/dflat stats ../logs/D-Portal-Logs --publishers

cd logs/D-Portal-Logs/
git add .
git commit -m.
git pull
git push
cd ../..


echo
echo "Updating SAVI-CRONOS github"
echo
cd dflat
rm -rf cronos
git clone git@github.com:xriss/savi-cronos.git cronos
./dflat cronos update
cd ..
